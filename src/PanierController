package controller;

import model.PanierItem;
import model.User;
import dao.DatabaseConnection;

import javax.swing.*;
import java.sql.*;
import java.util.List;

public class PanierController {

    public static boolean validerCommande(List<PanierItem> panier, User user) {
        if (panier == null || panier.isEmpty()) {
            JOptionPane.showMessageDialog(null, "Votre panier est vide !");
            return false;
        }

        if (user == null) {
            JOptionPane.showMessageDialog(null, "Aucun utilisateur connecté !");
            return false;
        }

        Connection conn = DatabaseConnection.getStaticConnection();
        if (conn == null) {
            JOptionPane.showMessageDialog(null, "Erreur de connexion à la base de données !");
            return false;
        }

        try {
            conn.setAutoCommit(false);

            double totalCommande = 0;
            for (PanierItem item : panier) {
                totalCommande += item.calculerPrixTotal();
            }

            String insertCommande = "INSERT INTO Commande (client_id, total) VALUES (?, ?)";
            int commandeId;

            try (PreparedStatement stmt = conn.prepareStatement(insertCommande, Statement.RETURN_GENERATED_KEYS)) {
                stmt.setInt(1, user.getId());
                stmt.setDouble(2, totalCommande);
                stmt.executeUpdate();
                ResultSet rs = stmt.getGeneratedKeys();
                if (rs.next()) {
                    commandeId = rs.getInt(1);
                } else {
                    throw new SQLException("Impossible de récupérer l'ID de la commande.");
                }
            }

    }
}
